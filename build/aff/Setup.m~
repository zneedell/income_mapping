load('GeoData.mat')
count = [4:31,34:40,42:80];
perc  = [32,33,41];

tractChanges = readtable('tiger/ma25trf.csv');

[ GeoData ] = rectifyCensus( tractChanges, GeoData_2009, GeoData_2014, count, perc );

GeoData_Joined = join(GeoData,GeoData_2014);
writetable(GeoData_Joined,'ACS_2010_Combined.csv');


%%

infFactor = 1.1021;

mapVars = table(GeoData_Joined.GEOid);
mapVars.GEOid2 = GeoData_Joined.GEOid2;

mapVars.Pop_2009 = GeoData_Joined.Pop_2009;
mapVars.Pop_Black_2009 = GeoData_Joined.Pop_Black_2009;
mapVars.Pop_WhiteNH_2009 = GeoData_Joined.Pop_WhiteNonHisp_2009;
mapVars.Pop_NonWhite_2009 = mapVars.Pop_2009 - mapVars.Pop_WhiteNH_2009;
mapVars.Perc_NonWhite_2009 = mapVars.Pop_NonWhite_2009./mapVars.Pop_2009;

mapVars.Pop_2014 = GeoData_Joined.Pop_2014;
mapVars.Pop_Black_2014 = GeoData_Joined.Pop_Black_2014;
mapVars.Pop_WhiteNH_2014 = GeoData_Joined.Pop_WhiteNonHisp_2014;
mapVars.Pop_NonWhite_2014 = mapVars.Pop_2014 - mapVars.Pop_WhiteNH_2014;
mapVars.Perc_NonWhite_2014 = mapVars.Pop_NonWhite_2014./mapVars.Pop_2014;


mapVars.IncMedian_2009 = GeoData_Joined.IncMedian_2009;
mapVars.MedianRent_2009 = GeoData_Joined.MedianRent_2009;
mapVars.IncMedian_2014 = GeoData_Joined.IncMedian_2014;
mapVars.MedianRent_2014 = GeoData_Joined.MedianRent_2014;
nRentBurdened_2009 = GeoData_Joined.RenterHouseholds_Count_2009 - ...
    (GeoData_Joined.RentIncPer_LT_10_2009 + GeoData_Joined.RentIncPer_10_15_2009 + ...
    GeoData_Joined.RentIncPer_15_20_2009 + GeoData_Joined.RentIncPer_20_25_2009 + GeoData_Joined.RentIncPer_25_30_2009);
mapVars.Perc_RentBurdened_2009 = nRentBurdened_2009./GeoData_Joined.RenterHouseholds_Count_2009;
nRentBurdened_2014 = GeoData_Joined.RenterHouseholds_Count_2014 - ...
    (GeoData_Joined.RentIncPer_LT_10_2014 + GeoData_Joined.RentIncPer_10_15_2014 + ...
    GeoData_Joined.RentIncPer_15_20_2014 + GeoData_Joined.RentIncPer_20_25_2014 + GeoData_Joined.RentIncPer_25_30_2014);
mapVars.Perc_RentBurdened_2014 = nRentBurdened_2014./GeoData_Joined.RenterHouseholds_Count_2014;

mapVars.HousingUnits_2009 = GeoData_Joined.HousingUnits_2009;
mapVars.OwnedUnits_2009 = GeoData_Joined.Owner_2009;
mapVars.RentedUnits_2009 = GeoData_Joined.Renter_2009;
mapVars.Perc_UnitsOwned_2009 = mapVars.OwnedUnits_2009./mapVars.HousingUnits_2009;

mapVars.HousingUnits_2014 = GeoData_Joined.HousingUnits_2014;
mapVars.OwnedUnits_2014 = GeoData_Joined.Owner_2014;
mapVars.RentedUnits_2014 = GeoData_Joined.Renter_2014;
mapVars.Perc_UnitsOwned_2014 = mapVars.OwnedUnits_2014./mapVars.HousingUnits_2014;

mapVars.NewArrivalOwner_2014 = GeoData_Joined.Owner_10_14_2014;
mapVars.DisplacedOwner_2014 = GeoData_Joined.Owner_2009 - (GeoData_Joined.Owner_2014 - GeoData_Joined.Owner_10_14_2014);
mapVars.NewArrivalRenter_2014 = GeoData_Joined.Renter_10_14_2014;
mapVars.DisplacedRenter_2014 = GeoData_Joined.Renter_2009 - (GeoData_Joined.Renter_2014 - GeoData_Joined.Renter_10_14_2014);
mapVars.Displaced_2014 = mapVars.DisplacedRenter_2014 + mapVars.DisplacedOwner_2014;
mapVars.NewArrival_2014 = mapVars.NewArrivalRenter_2014 + mapVars.NewArrivalOwner_2014;

mapVars.Perc_OwnerDisplaced = mapVars.DisplacedOwner_2014./GeoData_Joined.Owner_2009;
mapVars.Perc_RenterDisplaced = mapVars.DisplacedRenter_2014./GeoData_Joined.Renter_2009;
mapVars.Perc_Displaced = mapVars.Displaced_2014./GeoData_Joined.HousingUnits_2009;
mapVars.Perc_NewArrival = 

mapVars.IncMedianAbsChange = mapVars.IncMedian_2014 - mapVars.IncMedian_2009*infFactor;
mapVars.RentMedianAbsChange = mapVars.MedianRent_2014 - mapVars.MedianRent_2009*infFactor;
mapVars.IncMedianPercChange = (mapVars.IncMedian_2014/infFactor - mapVars.IncMedian_2009)./mapVars.IncMedian_2009;
mapVars.RentMedianPercChange = (mapVars.MedianRent_2014/infFactor - mapVars.MedianRent_2009)./mapVars.MedianRent_2009;

mapVars.Pop_NonWhite_Change = mapVars.Pop_NonWhite_2014 - mapVars.Pop_NonWhite_2009;
mapVars.Perc_NonWhite_Change = mapVars.Perc_NonWhite_2014 - mapVars.Perc_NonWhite_2009;

writetable(mapVars,'ACS_Map_Data.csv');
%%
mdl = fitlm(mapVars,'Perc_Displaced~Perc_NonWhite_2009^2+Perc_NonWhite_2009:IncMedian_2009+Perc_UnitsOwned_2009^2 +Perc_UnitsOwned_2009:Perc_NonWhite_2009 +Perc_RentBurdened_2009^2+IncMedian_2009^2' ...
    ,'Weights',mapVars.HousingUnits_2009)
%%
mdl2 = fitlm(mapVars,'Perc_Displaced~Perc_NonWhite_2009^2+Perc_UnitsOwned_2009+IncMedian_2009^2 + MedianRent_2009' ...
    ,'Weights',mapVars.HousingUnits_2009)